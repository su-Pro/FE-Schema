## 知道慢启动、拥塞避免、快速重传和快速恢复吗

由于TCP提供了可靠的字节流服务，他天生就非常有“意愿”占满整个链路上的带宽。但如果一个链路中存在着多个TCP连接，按照刚说的特点，很有可能发生“恶意拥塞”事件发生。

### 拥塞控制

因此TCP设计出了拥塞控制算法，他是对全局网络的一个考量。通过考虑整个网络的通信状况，给出最优传输的数据方案，实现链路上吞吐量最大化。主流的拥塞控制是**以网络中丢包情况**来考量的，例如：Reno算法，BIC算法，CUBIC算法。

![20200610121051]( https://supyyy-1259673491.cos.ap-beijing.myqcloud.com/2020/pictures20200610121051.png)

除此之外还有谷歌提出的以**探测带宽**作为依据BBR算法。

拥塞控制分为如下阶段：

- 慢启动
- 拥塞避免
- 快速重传
- 快速回复

以及两个核心状态：

- 拥塞窗口cwnd（congestion window）
- 慢启动阈值（Slow Start Threshold，ssthresh）

### 拥塞窗口

拥塞窗口指的是在收到对端 ACK 之前自己还能传输的最大 MSS 段数。他和接收窗口是有语义上的不同的：

- 接收窗口（rwnd）是接收端的限制，是接收端还能接收的数据量大小
- 拥塞窗口（cwnd）是发送端的限制，是发送端在还未收到对端 ACK 之前还能发送的数据量大小

> 拥塞控制的算法的本质是控制拥塞窗口（cwnd）的变化。

### 慢启动

每个 TCP 连接都有一个拥塞窗口的限制，最初这个值很小，随着时间的推移，每次发送的数据量如果在不丢包的情况下，“慢慢”的递增，这种机制被称为「慢启动」

![20200610123910]( https://supyyy-1259673491.cos.ap-beijing.myqcloud.com/2020/pictures20200610123910.png)

- 第一步，三次握手以后，双方通过 ACK 告诉了对方自己的接收窗口（rwnd）的大小，之后就可以互相发数据了
- 第二步，通信双方各自初始化自己的「拥塞窗口」（Congestion Window，cwnd）大小。
- 第三步，cwnd 初始值较小时，每收到一个 ACK，cwnd + 1，每经过一个 RTT，cwnd 变为之前的两倍。 过程如下图

#### 慢启动的初始窗口

最初的 TCP 初始拥塞窗口值为 3 或者 4，大于 4KB 左右，如今常见的 web 服务数据流都较短，比如一个页面只有 4k ~ 6k，在慢启动阶段，还没达到传输峰值，整个数据流就可能已经结束了。对于大文件传输，慢启动没有什么问题，慢启动造成的时延会被均摊到漫长的传输过程中。

根据 Google 的研究，90% 的 HTTP 请求数据都在 16KB 以内，约为 10 个 TCP 段。

![20200610124259]( https://supyyy-1259673491.cos.ap-beijing.myqcloud.com/2020/pictures20200610124259.png)

### 拥塞避免

当 cwnd > ssthresh 时，拥塞窗口进入「拥塞避免」阶段，在这个阶段会以线性方式增加 cwnd。


当发生丢包显现后，会将ssthresh 降为 当前cwnd 的 一半，并且将当前cwnd 设置成较少的数值,再次开启慢启动过程。

![20200610124740]( https://supyyy-1259673491.cos.ap-beijing.myqcloud.com/2020/pictures20200610124740.png)

> 前面介绍的慢启动和拥塞避免是 1988 年提出的拥塞控制方案，在 1990 年又出现了两种新的拥塞控制方案：「快速重传」和「快速恢复」

### 快速重传

快速重传的含义是：当接收端收到一个**失序数据段时**，TCP 立刻发送 1 个重复 ACK，而不用等有数据捎带确认，当发送端收到 3 个或以上重复 ACK，就意识到之前发的包可能丢了，于是马上进行重传，不用傻傻的等到重传定时器超时再重传。

#### 失序报文段

- 若报文丢失，将会产生连续的失序 ACK 段
- 若网络路径与设备导致数据段失序，将会产 生少量的失序 ACK 段
- 若报文重复，将会产生少量的失序 ACK 段

![20200610125146]( https://supyyy-1259673491.cos.ap-beijing.myqcloud.com/2020/pictures20200610125146.png)

#### 过程

规定接收方：

- 当接收到一个失序数据段时，立刻发送它所 期待的缺口 ACK 序列号

- 当接收到填充失序缺口的数据段时，立刻发 送它所期待的下一个 ACK 序列号

规定发送方

- 当接收到 3 个重复的失序 ACK 段（4 个相同 的失序 ACK 段）时，不再等待重传定时器的 触发，立刻基于快速重传机制重发报文段

流程如下：
![20200610125331]( https://supyyy-1259673491.cos.ap-beijing.myqcloud.com/2020/pictures20200610125331.png)

> 快速重传发生后并不会进入慢启动过程，因为此时只是收到重复 ACK，意味着网络仍在流动，会进入快速恢复阶段。

### 快速恢复

当收到三次重复 ACK 时，进入快速恢复阶段。解释为网络轻度拥塞。

- 拥塞阈值 ssthresh 降低为 cwnd 的一半：ssthresh = cwnd / 2
- 拥塞窗口 cwnd 设置为 ssthresh
- 拥塞窗口线性增加


![20200610125658]( https://supyyy-1259673491.cos.ap-beijing.myqcloud.com/2020/pictures20200610125658.png)