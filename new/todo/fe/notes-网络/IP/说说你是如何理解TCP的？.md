## 说说你是如何理解 TCP 的？

### 分层模型

![分层](../../../img/网络/TCP/分层.jpg)

可以看到协议的分层从上往下依次是

- Ethernet II：网络接口层以太网帧头部信息
- Internet Protocol Version 4：互联网层 IP 包头部信息
- Transmission Control Protocol：传输层的数据段头部信息，此处是 TCP 协议
- Hypertext Transfer Protocol：应用层 HTTP 的信息

#### 应用层（Application Layer）

应用层的本质是规定了应用程序之间如何相互传递报文， 以 HTTP 协议为例，它规定了

- 报文的类型，是请求报文还是响应报文
- 报文的语法，报文分为几段，各段是什么含义、用什么分隔，每个部分的每个字段什么什么含义
- 进程应该以什么样的时序发送报文和处理响应报文

#### 传输层（Transport Layer）

传输层的作用是为两台主机之间的「应用进程」提供端到端的逻辑通信,虽然是叫传输层，但是并不是将数据包从一台主机传送到另一台，而是对「传输行为进行控制」例如 TCP 协议提供数据包的重传、流量控制、拥塞控制等。

![TCP](../../../img/网络/TCP/传输层.jpg)

#### 网络互连层（Internet Layer）

网络互连层提供了主机到主机的通信，将传输层产生的的数据包封装成分组数据包发送到目标主机，并提供路由选择的能力.

IP 协议是网络层的主要协议，TCP 和 UDP 都是用 IP 协议作为网络层协议。这一层的主要作用是给包加上源地址和目标地址，将数据包传送到目标地址。

IP 协议是一个无连接的协议，也不具备重发机制，这也是 TCP 协议复杂的原因之一就是基于了这样一个「不靠谱」的协议。

#### 网络访问层（Network Access Layer）

网络访问层也有说法叫做网络接口层，以太网、Wifi、蓝牙工作在这一层，网络访问层提供了**主机连接到物理网络需要的硬件和相关的协议**

#### 分层的好处

分层的本质是通过分离关注点而让复杂问题简单化，通过分层可以做到：

- 灵活性高
- 便于测试和维护
- 各层之间独立
- 便于标准化

### 特点

TCP 是一个可靠的（reliable）、面向连接的（connection-oriented）、基于字节流（byte-stream）、全双工的（full-duplex）协议。

#### 面向连接的

面向连接的协议要求正式发送数据之前需要通过「握手」建立一个逻辑连接，结束通信时也是通过有序的四次挥手来断开连接。

#### 可靠的

IP 是一种无连接、不可靠的协议：它尽最大可能将数据报从发送者传输给接收者，但**并不保证**包到达的**顺序**会与它们被传输的顺序一致，也不保证包是否**重复**，甚至都不保证包**是否会达到**接收者。

因此 TCP 需要对如上几个问题进行一个改进：

- 对每个包进行提供**校验和**
- 包的**序列号**解决了顺序以及重复问题
- **超时重传**保证准确送达

> 校验和（checksum） 每个 TCP 包首部中都有两字节用来表示校验和，防止在传输过程中有损坏。如果收到一个校验和有差错的报文，TCP 不会发送任何确认直接丢弃它，等待发送端重传。

![](./../../../img/网络/TCP/校验和.jpg)

> 超时重传 TCP 发送数据后会启动一个定时器，等待对端确认收到这个数据包。如果在指定的时间内没有收到 ACK 确认，就会重传数据包，然后等待更长时间，如果还没有收到就再重传，在多次重传仍然失败以后，TCP 会放弃这个包。

#### 面向字节流

TCP 是一种字节流（byte-stream）协议，流的含义是没有固定的报文边界。

#### 双工协议

在 TCP 中发送端和接收端可以是客户端/服务端，也可以是服务器/客户端，通信的双方在任意时刻既可以是接收数据也可以是发送数据，每个方向的数据流都独立管理序列号、滑动窗口大小、MSS 等信息。
